App.sweep=App.sweep||{};App.sweep.photos={};var bitcore=require("bitcore-lib");function btcToSatoshi(e){return Math.round(e*1e8)}function satoshiToBTC(e){return e/1e8}window.ga=function(){};App.controller("start",function(e){var n=$(e);var t=n.find("#buy");App.analytics.pageLoad(n.attr("data-page"));var i=n.find("select");var a=document.cookie.split(";");var o="en";a.forEach(function(e){if(/lang=/.test(e)){o=e.replace(/.*lang=(.*)/,"$1")}});if(o){i.find('option[value="'+o+'"]').attr("selected","selected")}i.on("change",function(){var e=i.val();document.cookie="lang="+e;document.location="/?lang="+e});t.on("click",function(e){App.load("private-key")})});App.controller("private-key",function(e){var n=$(e);var t=n.find("#go-bitcoins");var i=n.find("#scan");var a=n.find(".photo");var o=n.find("#photo");var r=n.find("#video");var p=n.find("#private-key-input");var c=n.find(".address");var s=n.find("#address");var d=n.find("#unspent-confirmed");var l=n.find("#unspent-unconfirmed");var f=n.find(".instructions");var u=n.find(".instructions-scan");var v=n.find(".help");t.parent().hide();i.parent().hide();r.parent().hide();u.hide();c.hide();o.on("click",a.trigger.bind(a,"click"));a.on("change",function(e){App.sweep.incomingImage("private-key-photo",e);qrcode.callback=function(e){var n=m(e);if(n){p.val(n);r.parent().hide();f.hide();u.hide()}};qrcode.decode(App.sweep.photos["private-key-photo"])});var h=true;function g(){var e=p.val().trim();if(e.length==52){if(!h)return;h=false;App.sweep.validateBitcoinPrivateKey(e,function(n,t){if(n){p.removeClass("valid");p.addClass("invalid");c.hide();return}if(t){p.addClass("valid");p.removeClass("invalid");App.sweep.bitcoinPrivateKey=e;var i=new bitcore.PrivateKey(e);var a=i.publicKey.toAddress();s.text(a);c.fadeIn();A(a,function(e,n){console.log(n);d.text(n.balance);l.text(n.unconfirmedBalance);if(n.balance>0)w()})}else{p.removeClass("valid");p.addClass("invalid");c.hide()}})}else{p.removeClass("valid");p.removeClass("invalid");t.parent().hide();c.hide();h=true}}setInterval(g,200);function A(e,n){App.sweep.getBalance(e,function(e,t){if(e)return n(e);n(null,{balance:satoshiToBTC(t.balance),unconfirmedBalance:satoshiToBTC(t.unconfirmedBalance)})})}p.on("keyup",g);p.on("paste",g);function w(){t.on("click",function(e){t.parent().hide();if(typeof navigator.getUserMedia=="function"){r.parent().hide();f.hide();u.hide();r.html5_qrcode_stop()}App.load("bitcoin-address")});t.parent().fadeIn()}v.on("click",function(e){App.dialog(App.sweep.dialogHelpBitcoinPrivateKey,function(){})});function m(e){return e.replace(/bitcoin:/,"")}if(typeof MediaStreamTrack==="function"){MediaStreamTrack.getSources(function(e){var n=e.filter(function(e){return e.kind=="video"});if(n[0]){i.parent().show();u.show()}})}i.on("click",function(e){i.parent().hide();r.parent().show();var n=true;r.html5_qrcode(function(e){if(!n)return;var t=m(e);if(t){n=false;p.val(t);r.parent().hide();f.hide();u.hide();setTimeout(function(){r.html5_qrcode_stop()},0)}},function(e){},function(e){App.dialog(App.sweep.dialogErrorReload,function(){})})})});App.controller("bitcoin-address",function(e){var n=$(e);var t=n.find("#go-bitcoins");var i=n.find("#scan");var a=n.find(".photo");var o=n.find("#photo");var r=n.find("#video");var p=n.find("#bitcoin-address-input");var c=n.find(".sent");var s=n.find("#view-tx");var d=n.find(".instructions");var l=n.find(".instructions-scan");var f=n.find(".help");t.parent().hide();i.parent().hide();r.parent().hide();l.hide();c.hide();s.parent().hide();o.on("click",a.trigger.bind(a,"click"));a.on("change",function(e){App.sweep.incomingImage("address-photo",e);qrcode.callback=function(e){var n=A(e);if(n){p.val(n);r.parent().hide();d.hide();l.hide()}};qrcode.decode(App.sweep.photos["address-photo"])});var u=true;function v(){var e=p.val().trim();if(e.length==34){if(!u)return;u=false;App.sweep.validateBitcoinAddress(e,function(n,i){if(n){p.removeClass("valid");p.addClass("invalid");return}if(i){p.addClass("valid");p.removeClass("invalid");t.parent().show();h();App.sweep.bitcoinAddress=e}else{p.removeClass("valid");p.addClass("invalid")}})}else{p.removeClass("valid");p.removeClass("invalid");t.parent().hide();u=true}}setInterval(v,200);p.on("keyup",v);p.on("paste",v);t.on("click",function(e){i.parent().hide();l.hide();t.parent().hide();if(typeof navigator.getUserMedia=="function"){r.parent().hide();d.hide();l.hide();r.html5_qrcode_stop()}App.sweep.sweepBitcoins(App.sweep.bitcoinPrivateKey,App.sweep.bitcoinAddress,function(e,n){if(e){App.dialog(App.sweep.dialogErrorReload,function(){});return}g(n.txHash)})});s.on("click",function(e){document.location=s.data("url")});function h(){t.parent().fadeIn()}function g(e){c.fadeIn();s.parent().fadeIn();s.data("url","https://search.bitaccess.co/tx/"+e)}f.on("click",function(e){App.dialog(App.sweep.dialogHelpBitcoinAddress,function(){})});function A(e){return e.replace(/bitcoin:/,"")}if(typeof MediaStreamTrack==="function"){MediaStreamTrack.getSources(function(e){var n=e.filter(function(e){return e.kind=="video"});if(n[0]){i.parent().show();l.show()}})}i.on("click",function(e){i.parent().hide();r.parent().show();var n=true;r.html5_qrcode(function(e){if(!n)return;var t=A(e);if(t){n=false;p.val(t);r.parent().hide();d.hide();l.hide();setTimeout(function(){r.html5_qrcode_stop()},0)}},function(e){},function(e){App.dialog(App.sweep.dialogErrorReload,function(){})})})});App.controller("terms",function(e){var n=$(e);App.analytics.pageLoad(n.attr("data-page"));var t=n.find(".app-button.next");var i=n.find(".app-button.agree");t.parent().hide();i.on("click",function(e){i.parent().hide();t.parent().fadeIn()})});App.analytics={pageLoad:function(e){ga("send",{hitType:"event",eventCategory:"page",eventAction:"load",eventLabel:e})},fourOhThree:function(){ga("send",{hitType:"event",eventCategory:"security",eventAction:"violation",eventLabel:"403"})},fullyCompletely:function(){ga("send",{hitType:"event",eventCategory:"flow",eventAction:"completion"})}};App.sweep.validateBitcoinPrivateKey=function(e,n){setTimeout(function(){n(null,true)},100)};App.sweep.validateBitcoinAddress=function(e,n){setTimeout(function(){n(null,true)},100)};App.sweep.sweepBitcoins=function(e,n,t){var i=new bitcore.PrivateKey(e);var a=i.publicKey.toAddress();App.sweep.getUnspents(a,function(e,a){if(e)return t(e);var o=App.sweep.filterInputsByConfirmation(a,true);var r=App.sweep.createTransaction(i,n,o);if(!r){return t(new Error("unable to create transaction"))}console.log("transaction:",r.toJSON());App.sweep.lastTransaction=r;if(o.length<a.length){var p=App.sweep.tallyInputs(App.sweep.filterInputsByConfirmation(a,false));console.log("unconfirmedSatoshis:",p);var c=App.sweep.dialogUnconfirmedInputs;c.text=c.text.replace(/TT_AMOUNT/,satoshiToBTC(p)+"");App.dialog(c,function(e){if(e)s()})}else{s()}function s(){App.sweep.broadcastTransaction(r,t)}})};App.sweep.filterInputsByConfirmation=function(e,n){return e};App.sweep.tallyInputs=function(e){return e.reduce(function(e,n){e+=btcToSatoshi(n.amount);return e},0)};App.sweep.createTransaction=function(e,n,t){var i=App.sweep.tallyInputs(t);console.log("total unspent:",i);var a=i-60*100;console.log("minus fee:",a);if(a>0){var o=(new bitcore.Transaction).from(t).to(n,a).sign(e);return o}};App.sweep.getBalance=function(e,n){var t="/app/info/"+e;console.log("url:",t);$.ajax({type:"GET",url:t,dataType:"json",success:function(e){if(!e)return n(new Error("no data in response from "+t));n(null,e)},error:function(e,t,i){n(new Error("unknown error"),i)}})};App.sweep.getUnspents=function(e,n){var t="/app/unspents/"+e;console.log("url:",t);$.ajax({type:"GET",url:t,dataType:"json",success:function(e){if(!e)return n(new Error("no data in response from "+t));n(null,e)},error:function(e,t,i){n(new Error("unknown error"),i)}})};App.sweep.broadcastTransaction=function(e,n){var t="/app/broadcast";$.ajax({type:"POST",url:t,data:JSON.stringify({tx_hex:e.serialize()}),contentType:"application/json",dataType:"json",success:function(e){n(null,e)},error:function(e,t,i){n(new Error("unknown error"),i)}})};App.sweep.incomingImage=function(e,n){if(n.target.files.length==1&&n.target.files[0].type.indexOf("image/")==0){var t=URL.createObjectURL(n.target.files[0]);App.sweep.photos[e]=t}};App.load("start");
//# sourceMappingURL=sweepapp.min.js.map