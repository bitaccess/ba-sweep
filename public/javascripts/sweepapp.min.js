App.sweep=App.sweep||{};App.sweep.photos={};var bitcore=require("bitcore-lib");function btcToSatoshi(e){return Math.round(e*1e8)}function satoshiToBTC(e){return e/1e8}window.ga=function(){};App.controller("start",function(e){var n=$(e);var i=n.find("#buy");App.analytics.pageLoad(n.attr("data-page"));var t=n.find("select");var a=document.cookie.split(";");var r="en";a.forEach(function(e){if(/lang=/.test(e)){r=e.replace(/.*lang=(.*)/,"$1")}});if(r){t.find('option[value="'+r+'"]').attr("selected","selected")}t.on("change",function(){var e=t.val();document.cookie="lang="+e;document.location="/?lang="+e});i.on("click",function(e){App.load("private-key")})});App.controller("private-key",function(e){var n=$(e);var i=n.find("#go-bitcoins");var t=n.find("#scan");var a=n.find(".photo");var r=n.find("#photo");var o=n.find("#video");var p=n.find("#private-key-input");var c=n.find(".address");var d=n.find("#address");var s=n.find("#unspent-confirmed");var f=n.find("#unspent-unconfirmed");var l=n.find(".instructions");var u=n.find(".instructions-scan");var v=n.find(".wait");var h=n.find(".balance");var w=n.find(".unconfirmed");var A=n.find("#tx-fee");var g=n.find(".help");var y=n.find(".help-fee");var b=n.find(".not-a-private-key");v.hide();h.hide();w.hide();i.parent().hide();t.parent().hide();o.parent().hide();u.hide();c.hide();b.hide();r.on("click",a.trigger.bind(a,"click"));a.on("change",function(e){App.sweep.incomingImage("private-key-photo",e);qrcode.callback=function(e){var n=B(e);if(n){p.val(n);o.parent().hide();l.hide();u.hide()}};qrcode.decode(App.sweep.photos["private-key-photo"])});function m(){var e=p.val().trim();if(e.length==51||e.length==52){if(e==App.sweep.bitcoinPrivateKey)return;App.sweep.bitcoinPrivateKey=e;var n=App.sweep.validateBitcoinPrivateKey(e);if(n){b.hide();p.addClass("valid");p.removeClass("invalid");var t=new bitcore.PrivateKey(e);var a=t.publicKey.toAddress();d.text(a);c.fadeIn();v.show();h.hide();w.hide();T(a,function(e,n){v.hide();h.show();s.text(n.balance);f.text(n.unconfirmedBalance);A.text(satoshiToBTC(1e4));if(n.unconfirmedBalance!=0){w.show();A.parent().hide()}else if(n.balance>0){A.parent().show();k()}else{A.parent().hide()}})}else{p.removeClass("valid");p.addClass("invalid");c.hide();h.hide();w.hide();b.show()}}else{p.removeClass("valid");p.removeClass("invalid");i.parent().hide();c.hide();h.hide();w.hide()}}setInterval(m,200);function T(e,n){App.sweep.getBalance(e,function(e,i){if(e)return n(e);n(null,{balance:satoshiToBTC(i.balance),unconfirmedBalance:satoshiToBTC(i.unconfirmedBalance)})})}p.on("keyup",m);p.on("paste",m);i.on("click",function(e){i.parent().hide();if(typeof navigator.getUserMedia=="function"){o.parent().hide();l.hide();u.hide();o.html5_qrcode_stop()}App.load("bitcoin-address")});function k(){i.parent().fadeIn()}g.on("click",function(e){App.dialog(App.sweep.dialogHelpBitcoinPrivateKey,function(){})});y.on("click",function(e){App.dialog(App.sweep.dialogHelpFee,function(){})});function B(e){var n=e.replace(/.*bitcoin:/,"");var i=App.sweep.validateBitcoinPrivateKey(n);if(i)return n}function C(){if(typeof MediaStreamTrack==="function"&&typeof MediaStreamTrack.getSources==="function"){MediaStreamTrack.getSources(function(e){var n=e.filter(function(e){return e.kind=="video"});if(n[0]){t.parent().show();l.show();u.show()}})}}C();t.on("click",function(e){t.parent().hide();o.parent().show();o.html5_qrcode(function(e){var n=B(e);if(n){b.hide();if(p.val()!=n){App.sweep.bitcoinPrivateKey=null;p.val(n)}}else{p.val("not a private key");b.show()}},function(e){},function(e){App.dialog(App.sweep.dialogErrorReload,function(){})})})});App.controller("bitcoin-address",function(e){var n=$(e);var i=n.find("#go-bitcoins");var t=n.find("#scan");var a=n.find(".photo");var r=n.find("#photo");var o=n.find("#video");var p=n.find("#bitcoin-address-input");var c=n.find(".tx");var d=n.find("#tx-amount");var s=n.find("#tx-fee");var f=n.find(".sent");var l=n.find("#view-tx");var u=n.find(".instructions");var v=n.find(".instructions-scan");var h=n.find(".self");var w=n.find(".help");var A=n.find(".help-fee");var g=n.find(".not-a-public-key");i.parent().hide();t.parent().hide();o.parent().hide();v.hide();h.hide();f.hide();c.hide();l.parent().hide();g.hide();r.on("click",a.trigger.bind(a,"click"));a.on("change",function(e){App.sweep.incomingImage("address-photo",e);qrcode.callback=function(e){var n=T(e);if(n){o.parent().hide();u.hide();v.hide();h.hide();p.val(n)}};qrcode.decode(App.sweep.photos["address-photo"])});function y(){var e=p.val().trim();if(e.length>=26&&e.length<=35){if(App.sweep.bitcoinAddress==e)return;App.sweep.bitcoinAddress=e;var n=false;var t=App.sweep.validateBitcoinAddress(e);if(t){var a=new bitcore.PrivateKey(App.sweep.bitcoinPrivateKey);var r=a.publicKey.toAddress();if(r.toString()===e){h.show()}else{n=true;h.hide()}g.hide();p.addClass("valid");p.removeClass("invalid")}else{h.hide();g.show();p.removeClass("valid");p.addClass("invalid")}if(n){i.parent().show();b()}}else{p.removeClass("valid");p.removeClass("invalid");i.parent().hide()}}setInterval(y,200);p.on("keyup",y);p.on("paste",y);i.on("click",function(e){t.parent().hide();u.hide();p.parent().hide();v.hide();h.hide();i.parent().hide();if(typeof navigator.getUserMedia=="function"){o.parent().hide();u.hide();v.hide();h.hide();o.html5_qrcode_stop()}App.sweep.sweepBitcoins(App.sweep.bitcoinPrivateKey,App.sweep.bitcoinAddress,function(e){d.text(satoshiToBTC(e.outputAmount));s.text(satoshiToBTC(e.getFee()));c.fadeIn()},function(e,n){if(e){App.dialog(App.sweep.dialogErrorReload,function(){});return}m(n.txHash)})});l.on("click",function(e){document.location=l.data("url")});function b(){i.parent().fadeIn()}function m(e){f.fadeIn();l.parent().fadeIn();l.data("url","https://search.bitaccess.co/tx/"+e)}w.on("click",function(e){App.dialog(App.sweep.dialogHelpBitcoinAddress,function(){})});A.on("click",function(e){App.dialog(App.sweep.dialogHelpFee,function(){})});function T(e){var n=e.replace(/.*bitcoin:/,"");var i=App.sweep.validateBitcoinAddress(n);if(i)return n}function k(){if(typeof MediaStreamTrack==="function"&&typeof MediaStreamTrack.getSources==="function"){MediaStreamTrack.getSources(function(e){var n=e.filter(function(e){return e.kind=="video"});if(n[0]){t.parent().show();v.show()}})}}k();t.on("click",function(e){t.parent().hide();o.parent().show();o.html5_qrcode(function(e){var n=T(e);if(n){g.hide();if(p.val()!=n){App.sweep.bitcoinAddress=null;p.val(n)}}else{h.hide();p.val("not a public key");g.show()}},function(e){},function(e){App.dialog(App.sweep.dialogErrorReload,function(){})})})});App.controller("terms",function(e){var n=$(e);App.analytics.pageLoad(n.attr("data-page"));var i=n.find(".app-button.next");var t=n.find(".app-button.agree");i.parent().hide();t.on("click",function(e){t.parent().hide();i.parent().fadeIn()})});App.analytics={pageLoad:function(e){ga("send",{hitType:"event",eventCategory:"page",eventAction:"load",eventLabel:e})},fourOhThree:function(){ga("send",{hitType:"event",eventCategory:"security",eventAction:"violation",eventLabel:"403"})},fullyCompletely:function(){ga("send",{hitType:"event",eventCategory:"flow",eventAction:"completion"})}};App.sweep.validateBitcoinPrivateKey=function(e){try{new bitcore.PrivateKey(e)}catch(n){return false}return true};App.sweep.validateBitcoinAddress=function(e){try{bitcore.Address.fromString(e)}catch(n){return false}return true};App.sweep.sweepBitcoins=function(e,n,i,t){var a=new bitcore.PrivateKey(e);var r=a.publicKey.toAddress();App.sweep.getUnspents(r,function(e,r){if(e)return t(e);var o=App.sweep.filterInputsByConfirmation(r,true);var p=App.sweep.createTransaction(a,n,o);if(!p){return t(new Error("unable to create transaction"))}App.sweep.lastTransaction=p;i(p);if(o.length<r.length){var c=App.sweep.tallyInputs(App.sweep.filterInputsByConfirmation(r,false));var d=App.sweep.dialogUnconfirmedInputs;d.text=d.text.replace(/TT_AMOUNT/,satoshiToBTC(c)+"");App.dialog(d,function(e){if(e)s()})}else{s()}function s(){App.sweep.broadcastTransaction(p,t)}})};App.sweep.filterInputsByConfirmation=function(e,n){return e};App.sweep.tallyInputs=function(e){return e.reduce(function(e,n){e+=btcToSatoshi(n.amount);return e},0)};App.sweep.createTransaction=function(e,n,i){var t=App.sweep.tallyInputs(i);var a=t-1e4;if(a>0){var r=(new bitcore.Transaction).from(i).to(n,a).sign(e);return r}};App.sweep.getBalance=function(e,n){var i="/app/info/"+e;$.ajax({type:"GET",url:i,dataType:"json",success:function(e){if(!e)return n(new Error("no data in response from "+i));n(null,e)},error:function(e,i,t){n(new Error("unknown error"),t)}})};App.sweep.getUnspents=function(e,n){var i="/app/unspents/"+e;$.ajax({type:"GET",url:i,dataType:"json",success:function(e){if(!e)return n(new Error("no data in response from "+i));n(null,e)},error:function(e,i,t){n(new Error("unknown error"),t)}})};App.sweep.broadcastTransaction=function(e,n){var i="/app/broadcast";$.ajax({type:"POST",url:i,data:JSON.stringify({tx_hex:e.serialize()}),contentType:"application/json",dataType:"json",success:function(e){n(null,e)},error:function(e,i,t){n(new Error("unknown error"),t)}})};App.sweep.incomingImage=function(e,n){if(n.target.files.length==1&&n.target.files[0].type.indexOf("image/")==0){var i=URL.createObjectURL(n.target.files[0]);App.sweep.photos[e]=i}};App.load("start");
//# sourceMappingURL=sweepapp.min.js.map