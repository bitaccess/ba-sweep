App.sweep=App.sweep||{};App.sweep.photos={};var bitcore=require("bitcore-lib");function btcToSatoshi(e){return Math.round(e*1e8)}function satoshiToBTC(e){return e/1e8}window.ga=function(){};App.controller("start",function(e){var n=$(e);var i=n.find("#buy");App.analytics.pageLoad(n.attr("data-page"));var t=n.find("select");var a=document.cookie.split(";");var o="en";a.forEach(function(e){if(/lang=/.test(e)){o=e.replace(/.*lang=(.*)/,"$1")}});if(o){t.find('option[value="'+o+'"]').attr("selected","selected")}t.on("change",function(){var e=t.val();document.cookie="lang="+e;document.location="/?lang="+e});i.on("click",function(e){App.load("private-key")})});App.controller("private-key",function(e){var n=$(e);var i=n.find("#go-bitcoins");var t=n.find("#scan");var a=n.find(".photo");var o=n.find("#photo");var r=n.find("#video");var p=n.find("#private-key-input");var c=n.find(".address");var s=n.find("#address");var d=n.find("#unspent-confirmed");var l=n.find("#unspent-unconfirmed");var f=n.find(".instructions");var u=n.find(".instructions-scan");var v=n.find(".wait");var h=n.find(".balance");var w=n.find(".unconfirmed");var g=n.find("#tx-fee");var A=n.find(".help");var y=n.find(".help-fee");var m=n.find(".not-a-private-key");v.hide();h.hide();w.hide();i.parent().hide();t.parent().hide();r.parent().hide();u.hide();c.hide();m.hide();o.on("click",a.trigger.bind(a,"click"));a.on("change",function(e){App.sweep.incomingImage("private-key-photo",e);qrcode.callback=function(e){console.log("data",e);var n=B(e);if(n){p.val(n);r.parent().hide();f.hide();u.hide()}};qrcode.decode(App.sweep.photos["private-key-photo"])});function b(){var e=p.val().trim();if(e.length==51||e.length==52){if(e==App.sweep.bitcoinPrivateKey)return;App.sweep.bitcoinPrivateKey=e;var n=App.sweep.validateBitcoinPrivateKey(e);if(n){console.log("new valid private key");m.hide();p.addClass("valid");p.removeClass("invalid");var t=new bitcore.PrivateKey(e);var a=t.publicKey.toAddress();s.text(a);c.fadeIn();v.show();h.hide();w.hide();k(a,function(e,n){v.hide();console.log(n);h.show();d.text(n.balance);l.text(n.unconfirmedBalance);g.text(satoshiToBTC(1e4));if(n.unconfirmedBalance!=0){w.show();g.parent().hide()}else if(n.balance>0){g.parent().show();T()}else{g.parent().hide()}})}else{p.removeClass("valid");p.addClass("invalid");c.hide();h.hide();w.hide();m.show()}}else{p.removeClass("valid");p.removeClass("invalid");i.parent().hide();c.hide();h.hide();w.hide()}}setInterval(b,200);function k(e,n){App.sweep.getBalance(e,function(e,i){if(e)return n(e);n(null,{balance:satoshiToBTC(i.balance),unconfirmedBalance:satoshiToBTC(i.unconfirmedBalance)})})}p.on("keyup",b);p.on("paste",b);i.on("click",function(e){i.parent().hide();if(typeof navigator.getUserMedia=="function"){r.parent().hide();f.hide();u.hide();r.html5_qrcode_stop()}App.load("bitcoin-address")});function T(){i.parent().fadeIn()}A.on("click",function(e){App.dialog(App.sweep.dialogHelpBitcoinPrivateKey,function(){})});y.on("click",function(e){App.dialog(App.sweep.dialogHelpFee,function(){})});function B(e){var n=e.replace(/.*bitcoin:/,"");var i=App.sweep.validateBitcoinPrivateKey(n);if(i)return n}function C(){if(typeof MediaStreamTrack==="function"){MediaStreamTrack.getSources(function(e){var n=e.filter(function(e){return e.kind=="video"});if(n[0]){t.parent().show();f.show();u.show()}})}}C();t.on("click",function(e){t.parent().hide();r.parent().show();r.html5_qrcode(function(e){console.log("scan:",e);var n=B(e);if(n){m.hide();if(p.val()!=n){App.sweep.bitcoinPrivateKey=null;p.val(n)}}else{p.val("not a private key");m.show()}},function(e){},function(e){App.dialog(App.sweep.dialogErrorReload,function(){})})})});App.controller("bitcoin-address",function(e){var n=$(e);var i=n.find("#go-bitcoins");var t=n.find("#scan");var a=n.find(".photo");var o=n.find("#photo");var r=n.find("#video");var p=n.find("#bitcoin-address-input");var c=n.find(".tx");var s=n.find("#tx-amount");var d=n.find("#tx-fee");var l=n.find(".sent");var f=n.find("#view-tx");var u=n.find(".instructions");var v=n.find(".instructions-scan");var h=n.find(".self");var w=n.find(".help");var g=n.find(".help-fee");var A=n.find(".not-a-public-key");i.parent().hide();t.parent().hide();r.parent().hide();v.hide();h.hide();l.hide();c.hide();f.parent().hide();A.hide();o.on("click",a.trigger.bind(a,"click"));a.on("change",function(e){App.sweep.incomingImage("address-photo",e);qrcode.callback=function(e){var n=k(e);if(n){r.parent().hide();u.hide();v.hide();h.hide();p.val(n)}};qrcode.decode(App.sweep.photos["address-photo"])});function y(){var e=p.val().trim();if(e.length>=26&&e.length<=35){if(App.sweep.bitcoinAddress==e)return;App.sweep.bitcoinAddress=e;var n=false;var t=App.sweep.validateBitcoinAddress(e);if(t){var a=new bitcore.PrivateKey(App.sweep.bitcoinPrivateKey);var o=a.publicKey.toAddress();if(o.toString()===e){h.show()}else{n=true;h.hide()}A.hide();p.addClass("valid");p.removeClass("invalid")}else{h.hide();A.show();p.removeClass("valid");p.addClass("invalid")}if(n){i.parent().show();m()}}else{p.removeClass("valid");p.removeClass("invalid");i.parent().hide()}}setInterval(y,200);p.on("keyup",y);p.on("paste",y);i.on("click",function(e){t.parent().hide();u.hide();p.parent().hide();v.hide();h.hide();i.parent().hide();if(typeof navigator.getUserMedia=="function"){r.parent().hide();u.hide();v.hide();h.hide();r.html5_qrcode_stop()}App.sweep.sweepBitcoins(App.sweep.bitcoinPrivateKey,App.sweep.bitcoinAddress,function(e){console.log(e,e.outputAmount);s.text(satoshiToBTC(e.outputAmount));d.text(satoshiToBTC(e.getFee()));c.fadeIn()},function(e,n){if(e){App.dialog(App.sweep.dialogErrorReload,function(){});return}b(n.txHash)})});f.on("click",function(e){document.location=f.data("url")});function m(){i.parent().fadeIn()}function b(e){l.fadeIn();f.parent().fadeIn();f.data("url","https://search.bitaccess.co/tx/"+e)}w.on("click",function(e){App.dialog(App.sweep.dialogHelpBitcoinAddress,function(){})});g.on("click",function(e){App.dialog(App.sweep.dialogHelpFee,function(){})});function k(e){var n=e.replace(/.*bitcoin:/,"");var i=App.sweep.validateBitcoinAddress(n);if(i)return n}function T(){if(typeof MediaStreamTrack==="function"){MediaStreamTrack.getSources(function(e){var n=e.filter(function(e){return e.kind=="video"});if(n[0]){t.parent().show();v.show()}})}}T();t.on("click",function(e){t.parent().hide();r.parent().show();r.html5_qrcode(function(e){var n=k(e);if(n){A.hide();if(p.val()!=n){App.sweep.bitcoinAddress=null;p.val(n)}}else{h.hide();p.val("not a public key");A.show()}},function(e){},function(e){App.dialog(App.sweep.dialogErrorReload,function(){})})})});App.controller("terms",function(e){var n=$(e);App.analytics.pageLoad(n.attr("data-page"));var i=n.find(".app-button.next");var t=n.find(".app-button.agree");i.parent().hide();t.on("click",function(e){t.parent().hide();i.parent().fadeIn()})});App.analytics={pageLoad:function(e){ga("send",{hitType:"event",eventCategory:"page",eventAction:"load",eventLabel:e})},fourOhThree:function(){ga("send",{hitType:"event",eventCategory:"security",eventAction:"violation",eventLabel:"403"})},fullyCompletely:function(){ga("send",{hitType:"event",eventCategory:"flow",eventAction:"completion"})}};App.sweep.validateBitcoinPrivateKey=function(e){try{new bitcore.PrivateKey(e)}catch(n){return false}return true};App.sweep.validateBitcoinAddress=function(e){try{bitcore.Address.fromString(e)}catch(n){return false}return true};App.sweep.sweepBitcoins=function(e,n,i,t){var a=new bitcore.PrivateKey(e);var o=a.publicKey.toAddress();App.sweep.getUnspents(o,function(e,o){if(e)return t(e);var r=App.sweep.filterInputsByConfirmation(o,true);var p=App.sweep.createTransaction(a,n,r);if(!p){return t(new Error("unable to create transaction"))}console.log("transaction:",p.toJSON());App.sweep.lastTransaction=p;console.log("tx:",p,p.outputAmount);i(p);if(r.length<o.length){var c=App.sweep.tallyInputs(App.sweep.filterInputsByConfirmation(o,false));console.log("unconfirmedSatoshis:",c);var s=App.sweep.dialogUnconfirmedInputs;s.text=s.text.replace(/TT_AMOUNT/,satoshiToBTC(c)+"");App.dialog(s,function(e){if(e)d()})}else{d()}function d(){App.sweep.broadcastTransaction(p,t)}})};App.sweep.filterInputsByConfirmation=function(e,n){return e};App.sweep.tallyInputs=function(e){return e.reduce(function(e,n){e+=btcToSatoshi(n.amount);return e},0)};App.sweep.createTransaction=function(e,n,i){var t=App.sweep.tallyInputs(i);console.log("total unspent:",t);var a=t-1e4;console.log("minus fee:",a);if(a>0){var o=(new bitcore.Transaction).from(i).to(n,a).sign(e);return o}};App.sweep.getBalance=function(e,n){var i="/app/info/"+e;console.log("url:",i);$.ajax({type:"GET",url:i,dataType:"json",success:function(e){if(!e)return n(new Error("no data in response from "+i));n(null,e)},error:function(e,i,t){n(new Error("unknown error"),t)}})};App.sweep.getUnspents=function(e,n){var i="/app/unspents/"+e;console.log("url:",i);$.ajax({type:"GET",url:i,dataType:"json",success:function(e){if(!e)return n(new Error("no data in response from "+i));n(null,e)},error:function(e,i,t){n(new Error("unknown error"),t)}})};App.sweep.broadcastTransaction=function(e,n){var i="/app/broadcast";$.ajax({type:"POST",url:i,data:JSON.stringify({tx_hex:e.serialize()}),contentType:"application/json",dataType:"json",success:function(e){n(null,e)},error:function(e,i,t){n(new Error("unknown error"),t)}})};App.sweep.incomingImage=function(e,n){if(n.target.files.length==1&&n.target.files[0].type.indexOf("image/")==0){var i=URL.createObjectURL(n.target.files[0]);App.sweep.photos[e]=i}};App.load("start");
//# sourceMappingURL=sweepapp.min.js.map