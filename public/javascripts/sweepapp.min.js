App.sweep=App.sweep||{};App.sweep.photos={};var bitcore=require("bitcore-lib");function btcToSatoshi(e){return Math.round(e*1e8)}function satoshiToBTC(e){return e/1e8}window.ga=function(){};App.controller("start",function(e){var n=$(e);var t=n.find("#buy");App.analytics.pageLoad(n.attr("data-page"));var i=n.find("select");var a=document.cookie.split(";");var o="en";a.forEach(function(e){if(/lang=/.test(e)){o=e.replace(/.*lang=(.*)/,"$1")}});if(o){i.find('option[value="'+o+'"]').attr("selected","selected")}i.on("change",function(){var e=i.val();document.cookie="lang="+e;document.location="/?lang="+e});t.on("click",function(e){App.load("private-key")})});App.controller("private-key",function(e){var n=$(e);var t=n.find("#go-bitcoins");var i=n.find("#scan");var a=n.find(".photo");var o=n.find("#photo");var r=n.find("#video");var p=n.find("#private-key-input");var c=n.find(".address");var s=n.find("#address");var d=n.find("#unspent-confirmed");var l=n.find("#unspent-unconfirmed");var f=n.find(".instructions");var u=n.find(".instructions-scan");var v=n.find(".wait");var h=n.find(".balance");var g=n.find(".unconfirmed");var A=n.find("#tx-fee");var w=n.find(".help");var m=n.find(".help-fee");v.hide();h.hide();g.hide();t.parent().hide();i.parent().hide();r.parent().hide();u.hide();c.hide();o.on("click",a.trigger.bind(a,"click"));a.on("change",function(e){App.sweep.incomingImage("private-key-photo",e);qrcode.callback=function(e){console.log("data",e);var n=C(e);if(n){p.val(n);r.parent().hide();f.hide();u.hide()}};qrcode.decode(App.sweep.photos["private-key-photo"])});var y=true;function b(){var e=p.val().trim();if(e.length==51||e.length==52){if(!y)return;y=false;var n=App.sweep.validateBitcoinPrivateKey(e);if(n){p.addClass("valid");p.removeClass("invalid");App.sweep.bitcoinPrivateKey=e;var i=new bitcore.PrivateKey(e);var a=i.publicKey.toAddress();s.text(a);c.fadeIn();v.show();h.hide();g.hide();T(a,function(e,n){v.hide();console.log(n);h.show();d.text(n.balance);l.text(n.unconfirmedBalance);A.text(satoshiToBTC(1e4));if(n.unconfirmedBalance!=0){g.show()}else if(n.balance>0){k()}})}else{p.removeClass("valid");p.addClass("invalid");c.hide();h.hide();g.hide()}}else{p.removeClass("valid");p.removeClass("invalid");t.parent().hide();c.hide();h.hide();g.hide();y=true}}setInterval(b,200);function T(e,n){App.sweep.getBalance(e,function(e,t){if(e)return n(e);n(null,{balance:satoshiToBTC(t.balance),unconfirmedBalance:satoshiToBTC(t.unconfirmedBalance)})})}p.on("keyup",b);p.on("paste",b);function k(){t.on("click",function(e){t.parent().hide();if(typeof navigator.getUserMedia=="function"){r.parent().hide();f.hide();u.hide();r.html5_qrcode_stop()}App.load("bitcoin-address")});t.parent().fadeIn()}w.on("click",function(e){App.dialog(App.sweep.dialogHelpBitcoinPrivateKey,function(){})});m.on("click",function(e){App.dialog(App.sweep.dialogHelpFee,function(){})});function C(e){return e.replace(/bitcoin:/,"")}if(typeof MediaStreamTrack==="function"){MediaStreamTrack.getSources(function(e){var n=e.filter(function(e){return e.kind=="video"});if(n[0]){i.parent().show();u.show()}})}i.on("click",function(e){i.parent().hide();r.parent().show();var n=true;r.html5_qrcode(function(e){if(!n)return;var t=C(e);if(t){n=false;p.val(t);r.parent().hide();f.hide();u.hide();setTimeout(function(){r.html5_qrcode_stop()},0)}},function(e){},function(e){App.dialog(App.sweep.dialogErrorReload,function(){})})})});App.controller("bitcoin-address",function(e){var n=$(e);var t=n.find("#go-bitcoins");var i=n.find("#scan");var a=n.find(".photo");var o=n.find("#photo");var r=n.find("#video");var p=n.find("#bitcoin-address-input");var c=n.find(".tx");var s=n.find("#tx-amount");var d=n.find("#tx-fee");var l=n.find(".sent");var f=n.find("#view-tx");var u=n.find(".instructions");var v=n.find(".instructions-scan");var h=n.find(".self");var g=n.find(".help");var A=n.find(".help-fee");t.parent().hide();i.parent().hide();r.parent().hide();v.hide();h.hide();l.hide();c.hide();f.parent().hide();o.on("click",a.trigger.bind(a,"click"));a.on("change",function(e){App.sweep.incomingImage("address-photo",e);qrcode.callback=function(e){var n=T(e);if(n){r.parent().hide();u.hide();v.hide();h.hide();p.val(n)}};qrcode.decode(App.sweep.photos["address-photo"])});var w=true;function m(){var e=p.val().trim();if(e.length>=26&&e.length<=35){if(!w)return;w=false;var n=App.sweep.validateBitcoinAddress(e);var i=new bitcore.PrivateKey(App.sweep.bitcoinPrivateKey);var a=i.publicKey.toAddress();if(a.toString()===e){n=false;h.show()}if(n){p.addClass("valid");p.removeClass("invalid");t.parent().show();y();App.sweep.bitcoinAddress=e}else{p.removeClass("valid");p.addClass("invalid")}}else{p.removeClass("valid");p.removeClass("invalid");t.parent().hide();w=true}}setInterval(m,200);p.on("keyup",m);p.on("paste",m);t.on("click",function(e){i.parent().hide();u.hide();p.parent().hide();v.hide();h.hide();t.parent().hide();if(typeof navigator.getUserMedia=="function"){r.parent().hide();u.hide();v.hide();h.hide();r.html5_qrcode_stop()}App.sweep.sweepBitcoins(App.sweep.bitcoinPrivateKey,App.sweep.bitcoinAddress,function(e){console.log(e,e.outputAmount);s.text(satoshiToBTC(e.outputAmount));d.text(satoshiToBTC(e.getFee()));c.fadeIn()},function(e,n){if(e){App.dialog(App.sweep.dialogErrorReload,function(){});return}b(n.txHash)})});f.on("click",function(e){document.location=f.data("url")});function y(){t.parent().fadeIn()}function b(e){l.fadeIn();f.parent().fadeIn();f.data("url","https://search.bitaccess.co/tx/"+e)}g.on("click",function(e){App.dialog(App.sweep.dialogHelpBitcoinAddress,function(){})});A.on("click",function(e){App.dialog(App.sweep.dialogHelpFee,function(){})});function T(e){return e.replace(/bitcoin:/,"")}if(typeof MediaStreamTrack==="function"){MediaStreamTrack.getSources(function(e){var n=e.filter(function(e){return e.kind=="video"});if(n[0]){i.parent().show();v.show()}})}i.on("click",function(e){i.parent().hide();r.parent().show();var n=true;r.html5_qrcode(function(e){if(!n)return;var t=T(e);if(t){n=false;p.val(t);r.parent().hide();u.hide();v.hide();setTimeout(function(){r.html5_qrcode_stop()},0)}},function(e){},function(e){App.dialog(App.sweep.dialogErrorReload,function(){})})})});App.controller("terms",function(e){var n=$(e);App.analytics.pageLoad(n.attr("data-page"));var t=n.find(".app-button.next");var i=n.find(".app-button.agree");t.parent().hide();i.on("click",function(e){i.parent().hide();t.parent().fadeIn()})});App.analytics={pageLoad:function(e){ga("send",{hitType:"event",eventCategory:"page",eventAction:"load",eventLabel:e})},fourOhThree:function(){ga("send",{hitType:"event",eventCategory:"security",eventAction:"violation",eventLabel:"403"})},fullyCompletely:function(){ga("send",{hitType:"event",eventCategory:"flow",eventAction:"completion"})}};App.sweep.validateBitcoinPrivateKey=function(e){try{new bitcore.PrivateKey(e)}catch(n){return false}return true};App.sweep.validateBitcoinAddress=function(e){try{bitcore.Address.fromString(e)}catch(n){return false}return true};App.sweep.sweepBitcoins=function(e,n,t,i){var a=new bitcore.PrivateKey(e);var o=a.publicKey.toAddress();App.sweep.getUnspents(o,function(e,o){if(e)return i(e);var r=App.sweep.filterInputsByConfirmation(o,true);var p=App.sweep.createTransaction(a,n,r);if(!p){return i(new Error("unable to create transaction"))}console.log("transaction:",p.toJSON());App.sweep.lastTransaction=p;console.log("tx:",p,p.outputAmount);t(p);if(r.length<o.length){var c=App.sweep.tallyInputs(App.sweep.filterInputsByConfirmation(o,false));console.log("unconfirmedSatoshis:",c);var s=App.sweep.dialogUnconfirmedInputs;s.text=s.text.replace(/TT_AMOUNT/,satoshiToBTC(c)+"");App.dialog(s,function(e){if(e)d()})}else{d()}function d(){App.sweep.broadcastTransaction(p,i)}})};App.sweep.filterInputsByConfirmation=function(e,n){return e};App.sweep.tallyInputs=function(e){return e.reduce(function(e,n){e+=btcToSatoshi(n.amount);return e},0)};App.sweep.createTransaction=function(e,n,t){var i=App.sweep.tallyInputs(t);console.log("total unspent:",i);var a=i-1e4;console.log("minus fee:",a);if(a>0){var o=(new bitcore.Transaction).from(t).to(n,a).sign(e);return o}};App.sweep.getBalance=function(e,n){var t="/app/info/"+e;console.log("url:",t);$.ajax({type:"GET",url:t,dataType:"json",success:function(e){if(!e)return n(new Error("no data in response from "+t));n(null,e)},error:function(e,t,i){n(new Error("unknown error"),i)}})};App.sweep.getUnspents=function(e,n){var t="/app/unspents/"+e;console.log("url:",t);$.ajax({type:"GET",url:t,dataType:"json",success:function(e){if(!e)return n(new Error("no data in response from "+t));n(null,e)},error:function(e,t,i){n(new Error("unknown error"),i)}})};App.sweep.broadcastTransaction=function(e,n){var t="/app/broadcast";$.ajax({type:"POST",url:t,data:JSON.stringify({tx_hex:e.serialize()}),contentType:"application/json",dataType:"json",success:function(e){n(null,e)},error:function(e,t,i){n(new Error("unknown error"),i)}})};App.sweep.incomingImage=function(e,n){if(n.target.files.length==1&&n.target.files[0].type.indexOf("image/")==0){var t=URL.createObjectURL(n.target.files[0]);App.sweep.photos[e]=t}};App.load("start");
//# sourceMappingURL=sweepapp.min.js.map